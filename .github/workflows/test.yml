name: Test Suite

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - unit
          - integration
          - e2e
          - security
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18.x'
  AWS_REGION: 'eu-west-1'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      inputs.test_type == 'all' ||
      inputs.test_type == 'unit'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Test Lambda Functions
        run: |
          for dir in lambda/*/; do
            if [ -f "${dir}package.json" ]; then
              echo "Testing $(basename $dir)..."
              cd "$dir"
              npm ci
              if npm run | grep -q "test"; then
                npm test || echo "Tests failed for $(basename $dir)"
              fi
              cd ../..
            fi
          done
        continue-on-error: true

      - name: Test Frontend
        working-directory: frontend
        run: |
          npm ci
          if npm run | grep -q "test"; then
            npm test -- --passWithNoTests --coverage
          fi
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
        continue-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      inputs.test_type == 'all' ||
      inputs.test_type == 'integration'
    environment: sandbox

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        working-directory: tests/integration
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Run DynamoDB access pattern tests
        working-directory: scripts
        run: |
          npm install
          node test-access-patterns.js
        continue-on-error: true

      - name: Run conditional write tests
        working-directory: scripts
        run: |
          node test-conditional-writes.js
        continue-on-error: true

      - name: Test API endpoints
        env:
          API_URL: ${{ secrets.API_URL }}
          COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
          COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
        run: |
          # Create test user and get token
          # Run API integration tests
          echo "Running API integration tests..."
        continue-on-error: true

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: |
      inputs.test_type == 'all' ||
      inputs.test_type == 'e2e'
    environment: sandbox

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Playwright
        working-directory: tests/e2e
        run: |
          if [ -f package.json ]; then
            npm ci
            npx playwright install --with-deps chromium
          fi

      - name: Run E2E tests
        working-directory: tests/e2e
        env:
          BASE_URL: ${{ secrets.FRONTEND_URL }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          if [ -f package.json ] && npm run | grep -q "test:e2e"; then
            npm run test:e2e
          else
            echo "No E2E tests configured"
          fi
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 7

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    if: |
      inputs.test_type == 'all' ||
      inputs.test_type == 'security'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Run npm audit
        run: |
          echo "=== Frontend Security Audit ==="
          cd frontend && npm audit --production || true

          echo ""
          echo "=== Lambda Security Audit ==="
          for dir in lambda/*/; do
            if [ -f "${dir}package.json" ]; then
              echo "Auditing $(basename $dir)..."
              cd "$dir"
              npm audit --production || true
              cd ../..
            fi
          done
        continue-on-error: true

      - name: Run infrastructure security tests
        working-directory: scripts
        run: |
          if [ -x security-tests.sh ]; then
            bash security-tests.sh
          fi
        continue-on-error: true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Run tflint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize tflint
        working-directory: terraform
        run: tflint --init

      - name: Run tflint
        working-directory: terraform
        run: tflint --recursive

  lint-and-format:
    name: Linting & Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        working-directory: frontend
        run: npm run lint
        continue-on-error: true

      - name: Run Prettier check
        working-directory: frontend
        run: |
          if npm run | grep -q "format:check"; then
            npm run format:check
          fi
        continue-on-error: true

      - name: TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Check shell scripts
        run: |
          find scripts -name "*.sh" -type f -exec shellcheck {} + || true
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests, terraform-validate, lint-and-format]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Terraform Validation: ${{ needs.terraform-validate.result }}"
          echo "Lint & Format: ${{ needs.lint-and-format.result }}"

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Unit Tests': '${{ needs.unit-tests.result }}',
              'Integration Tests': '${{ needs.integration-tests.result }}',
              'Security Tests': '${{ needs.security-tests.result }}',
              'Terraform Validation': '${{ needs.terraform-validate.result }}',
              'Lint & Format': '${{ needs.lint-and-format.result }}'
            };

            const emoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              return '⏭️';
            };

            let body = '## Test Results\n\n';
            for (const [test, result] of Object.entries(results)) {
              body += `${emoji(result)} **${test}**: ${result}\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Fail if critical tests failed
        if: |
          needs.terraform-validate.result == 'failure' ||
          needs.lint-and-format.result == 'failure'
        run: exit 1
