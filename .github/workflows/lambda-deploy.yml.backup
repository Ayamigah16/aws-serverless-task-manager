name: Lambda Functions Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
        - sandbox
        - staging
        - production
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
  push:
    branches:
    - main
    - develop
    paths:
    - 'lambda/**'
    - '.github/workflows/lambda-deploy.yml'

env:
  NODE_VERSION: '18.x'
  AWS_REGION: 'eu-west-1'

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    name: Detect Changed Lambda Functions
    runs-on: ubuntu-latest
    outputs:
      functions: ${{ steps.filter.outputs.functions }}
      any_changed: ${{ steps.filter.outputs.any_changed }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Detect changed Lambda functions
      id: filter
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # Deploy all functions on manual trigger
          functions='["task-api","users-api","appsync-resolver","stream-processor","file-processor","github-webhook","notification-handler","presigned-url","pre-signup-trigger"]'
          echo "any_changed=true" >> $GITHUB_OUTPUT
        else
          # Detect changed functions
          changed_files=$(git diff --name-only HEAD^ HEAD | grep '^lambda/' || true)
          if [ -z "$changed_files" ]; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
            echo "functions=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          functions=$(echo "$changed_files" | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "any_changed=true" >> $GITHUB_OUTPUT
        fi
        echo "functions=$functions" >> $GITHUB_OUTPUT
        echo "Changed functions: $functions"

  build-and-deploy:
    name: Build & Deploy Lambda - ${{ matrix.function }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    environment: ${{ inputs.environment || 'sandbox' }}
    strategy:
      matrix:
        function: ${{ fromJson(needs.detect-changes.outputs.functions) }}
      fail-fast: false
      max-parallel: 3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: lambda/${{ matrix.function }}/package-lock.json

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-Lambda-${{ matrix.function }}

    - name: Install dependencies
      working-directory: lambda/${{ matrix.function }}
      run: |
        if [ -f package.json ]; then
          npm ci --production
        fi

    - name: Run tests
      working-directory: lambda/${{ matrix.function }}
      run: |
        if [ -f package.json ] && npm run | grep -q "test"; then
          npm install --save-dev
          npm test || echo "No tests found"
        fi

    - name: Build Lambda package
      working-directory: lambda/${{ matrix.function }}
      run: |
        rm -f function.zip
        if [ -d node_modules ]; then
          zip -qr function.zip . -x "*.git*" "*.zip" "tests/*" "*.test.js"
        else
          zip -q function.zip index.js package.json
        fi
        echo "Package size: $(du -h function.zip | cut -f1)"

    - name: Deploy Lambda function
      working-directory: lambda/${{ matrix.function }}
      env:
        ENVIRONMENT: ${{ inputs.environment || 'sandbox' }}
      run: |
        FUNCTION_NAME="task-manager-${ENVIRONMENT}-${{ matrix.function }}"

        # Check if function exists
        if aws lambda get-function --function-name $FUNCTION_NAME 2>/dev/null; then
          echo "Updating existing function: $FUNCTION_NAME"
          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --zip-file fileb://function.zip \
            --publish

          # Wait for update to complete
          aws lambda wait function-updated --function-name $FUNCTION_NAME

          echo "âœ“ Lambda function updated successfully"
        else
          echo "âš ï¸  Function $FUNCTION_NAME does not exist. Please deploy infrastructure first."
          exit 1
        fi

    - name: Update function configuration (if needed)
      working-directory: lambda/${{ matrix.function }}
      env:
        ENVIRONMENT: ${{ inputs.environment || 'sandbox' }}
      run: |
        FUNCTION_NAME="task-manager-${ENVIRONMENT}-${{ matrix.function }}"

        # Update environment variables if config.json exists
        if [ -f config.json ]; then
          aws lambda update-function-configuration \
            --function-name $FUNCTION_NAME \
            --environment "Variables=$(cat config.json | jq -c .environment)" \
            --timeout 30 \
            --memory-size 512
        fi

    - name: Tag deployment
      env:
        ENVIRONMENT: ${{ inputs.environment || 'sandbox' }}
      run: |
        FUNCTION_NAME="task-manager-${ENVIRONMENT}-${{ matrix.function }}"
        aws lambda tag-resource \
          --resource $(aws lambda get-function --function-name $FUNCTION_NAME --query 'Configuration.FunctionArn' --output text) \
          --tags \
            "DeployedBy=GitHub-Actions" \
            "DeployedAt=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            "GitCommit=${{ github.sha }}" \
            "GitBranch=${{ github.ref_name }}"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: lambda-${{ matrix.function }}-${{ inputs.environment || 'sandbox' }}
        path: lambda/${{ matrix.function }}/function.zip
        retention-days: 7

  build-layer:
    name: Build & Deploy Lambda Layer
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'sandbox' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Build Lambda Layer
      working-directory: lambda/layers/shared-layer
      run: |
        rm -rf nodejs
        mkdir -p nodejs

        if [ -f package.json ]; then
          npm ci --production --prefix nodejs
          cp *.js nodejs/ 2>/dev/null || true
        fi

        zip -qr layer.zip nodejs/
        echo "Layer size: $(du -h layer.zip | cut -f1)"

    - name: Publish Lambda Layer
      working-directory: lambda/layers/shared-layer
      env:
        ENVIRONMENT: ${{ inputs.environment || 'sandbox' }}
      run: |
        LAYER_NAME="task-manager-${ENVIRONMENT}-shared-layer"

        aws lambda publish-layer-version \
          --layer-name $LAYER_NAME \
          --description "Shared utilities for Task Manager Lambda functions" \
          --zip-file fileb://layer.zip \
          --compatible-runtimes nodejs18.x nodejs20.x \
          --license-info "MIT" > layer-version.json

        LAYER_VERSION_ARN=$(cat layer-version.json | jq -r '.LayerVersionArn')
        echo "Published layer: $LAYER_VERSION_ARN"
        echo "LAYER_VERSION_ARN=$LAYER_VERSION_ARN" >> $GITHUB_ENV

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [ build-and-deploy, build-layer ]
    if: always()
    steps:
    - name: Determine status
      id: status
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ] && [ "${{ needs.build-layer.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "emoji=âœ…" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "emoji=ðŸš¨" >> $GITHUB_OUTPUT
        fi

    - name: Notify Slack
      if: always()
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "${{ steps.status.outputs.emoji }} Lambda Deployment ${{ steps.status.outputs.status }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Lambda Functions Deployment*\n*Status:* ${{ steps.status.outputs.status }}\n*Environment:* ${{ inputs.environment || 'sandbox' }}\n*Triggered by:* ${{ github.actor }}\n*Commit:* ${{ github.sha }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true
