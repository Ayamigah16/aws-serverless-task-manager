version: 1
frontend:
  phases:
    preBuild:
      commands:
      - cd frontend
      - echo "Installing dependencies..."
      - npm ci --legacy-peer-deps
      - echo "Node version:"
      - node --version
      - echo "NPM version:"
      - npm --version
    build:
      commands:
      - echo "Environment variables check..."
      - |
        if [ -z "$NEXT_PUBLIC_COGNITO_USER_POOL_ID" ]; then
          echo "ERROR: Required environment variables not set"
          exit 1
        fi
      - echo "Building Next.js production application..."
      - npm run build
      - echo "Build completed successfully"
    postBuild:
      commands:
      - echo "Running post-build optimizations..."
      - du -sh .next
  artifacts:
    baseDirectory: frontend/.next
    files:
    - '**/*'
  cache:
    paths:
    - frontend/node_modules/**/*
    - frontend/.next/cache/**/*
  customHeaders:
  - pattern: '**/*'
    headers:
    - key: 'Strict-Transport-Security'
      value: 'max-age=31536000; includeSubDomains; preload'
    - key: 'X-Frame-Options'
      value: 'SAMEORIGIN'
    - key: 'X-Content-Type-Options'
      value: 'nosniff'
    - key: 'X-XSS-Protection'
      value: '1; mode=block'
    - key: 'Referrer-Policy'
      value: 'strict-origin-when-cross-origin'
    - key: 'Permissions-Policy'
      value: 'camera=(), microphone=(), geolocation=()'
    - key: 'Content-Security-Policy'
      value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.amazonaws.com https://*.amplifyapp.com;"
  - pattern: '**/*.js'
    headers:
    - key: 'Cache-Control'
      value: 'public, max-age=31536000, immutable'
  - pattern: '**/*.css'
    headers:
    - key: 'Cache-Control'
      value: 'public, max-age=31536000, immutable'
  - pattern: '**/*.{png,jpg,jpeg,gif,svg,ico,webp}'
    headers:
    - key: 'Cache-Control'
      value: 'public, max-age=31536000, immutable'
  - pattern: '/api/**'
    headers:
    - key: 'Cache-Control'
      value: 'no-store, no-cache, must-revalidate'
